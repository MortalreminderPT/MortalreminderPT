---
layout: post
title: 计算机网络（四）网络层
description:
date: 2024-10-22 07:01:45 +0800
image: https://www.koombea.com/wp-content/uploads/2024/02/Essentials-of-Enterprise-Networking-1100x616.webp
tags:
- Computer Network
category: ['Computer Network']
---

1. 目录
{:toc}

**网络层的作用**  
- **连接不同网络（互联）**：使多个网络之间能够进行通信。  
- **路由**：确定数据传输的最佳路径。  

---

### **无连接 vs. 面向连接**  

#### **无连接（Datagram）**  
- 类似于寄信，每个数据包都是独立的，走自己的路径。  
- 不需要预先建立路径，数据包可能无序到达。  
- 示例：互联网的数据传输。  

#### **面向连接（Virtual-Circuit）**  
- 类似于打电话，通信开始前先建立稳定的路径。  
- 所有数据包走同一路径，保证顺序到达。  
- 示例：视频会议或VoIP通话。  

| **比较**               | **Datagram**                                    | **Virtual-Circuit**                            |
|-------------------------|------------------------------------------------|-----------------------------------------------|
| **路径建立**           | 不需要建立连接。                               | 需要建立连接。                                 |
| **地址**               | 每个数据包都需要完整的地址信息。                 | 数据包仅需简短的虚电路标识符。                 |
| **路由**               | 每个数据包独立决定路径。                         | 预先确定好路径。                               |
| **路由器故障的影响**   | 仅影响当前的数据包传输。                         | 会中断正在进行的通信。                         |
| **服务质量**           | 难以保证服务质量。                               | 服务质量较容易保证。                           |
| **拥塞控制**           | 难以管理拥塞。                                   | 资源预留后更易控制拥塞。                       |

**总结**：  
- Virtual-Circuit提供更好的QoS和拥塞控制。  
- Datagram灵活无需连接，但需要较大的路由表和额外开销。  
- **IP协议使用Datagram网络。**  

---

### **Tunneling**  
- 当源和目标处于同一网络，但中间有其他网络时使用。  
- 源数据包被封装在另一个数据包中进行传输。  

---

### **Fragmentation（分片）**  
- 将大数据包拆分成较小的片段，以适应网络的最大传输单元（MTU）。

**分片类型**：  
1. **Transparent（透明分片）**：每经过一个网络，都会分片和重组。  
2. **Non-Transparent（非透明分片）**：仅在目的地重组数据包。  

---

### **IPv4 Datagram结构**  

| **字段**               | **描述**                                        |
|-------------------------|------------------------------------------------|
| **Version**             | 4位，表示协议版本（IPv4）。                    |
| **IHL**                 | 头部长度，单位为32位（最小5，最大15）。         |
| **Differentiated Services** | 8位，用于定义QoS或优先级。                  |
| **Total Length**        | 16位，数据包总大小（最大65535字节）。          |
| **Identification**      | 16位，标识数据包，用于分片重组。               |
| **Flags (DF, MF)**      | 控制分片行为。                                  |
| **Fragment Offset**     | 13位，当前分片在数据包中的位置。               |
| **TTL**                 | 8位，数据包的生存时间（跳数或秒）。            |
| **Protocol**            | 8位，指明协议（例如TCP或UDP）。                 |
| **Header Checksum**     | 16位，仅验证头部的完整性。                     |
| **Source Address**      | 32位，发送方的IP地址。                         |
| **Destination Address** | 32位，接收方的IP地址。                         |
| **Options**             | 可选字段，例如时间戳或路由控制。               |

- **头部大小**：  
  - 最小：20字节（IHL=5）。  
  - 最大：60字节（IHL=15，包含选项）。  

---

### **IP地址和子网**  

#### **IP地址**  
- 表示网络中设备的位置，例如 `192.168.0.1`。  

#### **子网掩码**  
- 区分网络部分和主机部分，例如 `192.168.1.0/24` 表示网络部分为24位。  

#### **类地址（Classful Addressing）**  
- 按固定的块划分IP地址：  
  - **Class A**：大规模网络。  
  - **Class B**：中等规模网络。  
  - **Class C**：小规模网络。  

#### **CIDR（Classless Inter-Domain Routing）**  
- 允许灵活分配地址块，例如 `/24`。  

**示例**：  
- 子网 `135.46.56.0/21` 最多可容纳 \( 2^{11} = 2048 \) 个地址。  

---

### **NAT（网络地址转换）**  
- 用一个外部IP地址表示多个内部IP地址，节约IP地址空间。  

**与五层架构的冲突**：  
- 打破层次透明性：NAT修改了网络层（IP地址）和传输层（端口号）数据。  
- 源地址和端口被改变，影响端到端的通信透明性。  

---

### **ICP（Internet Control Protocols）**  

1. **ICMP（互联网控制消息协议）**：  
   - 报告错误和诊断（如ping和traceroute）。  

2. **ARP（地址解析协议）**：  
   - 将IP地址映射到MAC地址，用于本地通信。  

3. **DHCP（动态主机配置协议）**：  
   - 动态分配IP地址给设备，使其接入网络。  
