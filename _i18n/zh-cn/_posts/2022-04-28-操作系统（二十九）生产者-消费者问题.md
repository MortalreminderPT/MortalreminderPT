---
layout: post 
title: 操作系统（二十九）生产者-消费者问题
description: 进程（Process）是进程实体的运行过程，是系统进行资源分配和调度的一个独立单位。
date: 2022-04-28 09:16:23 +0800 
image: /images/covers/操作系统-cover2.png
tags:
- 操作系统
---

1. 目录
{:toc}

## PV操作问题的一般思路：
1. 关系分析。找出题目中描述的各个进程，分析它们之间的同步、互斥关系。 
2. 整理思路。根据各进程的操作流程确定P、V操作的大致顺序。 
3. 设置信号量。设置需要的信号量，并根据题目条件确定信号量初值。（互斥信号量初值一般为1，同步信号量的初始值要看对应资源的初始值是多少）

## 问题描述

系统中有一组生产者进程和一组消费者进程。
生产者进程每次生产一个产品放入缓冲区，消费者进程每次从缓冲区中取出一个产品并使用。（这里的“产品”理解为某种数据）

生产者、消费者共享一个初始为空、大小为n的缓冲区。

只有**缓冲区没满**时，**生产者才能把产品放入缓冲区**，否则必须等待。

只有**缓冲区不空**时，**消费者才能从中取出产品**，否则必须等待。

**缓冲区是临界资源**，各进程必须**互斥地访问**。

## 实现原理

生产者-消费者问题是一个互斥、同步的综合问题。

对于初学者来说最难的是发现题目中隐含的两对同步关系。

有时候是消费者需要等待生产者生产，有时候是生产者要等待消费者消费。这是两个不同的“一前一后问题”，因此也需要设置两个同步信号量。

生产者-消费者问题的前驱关系如下图所示：

<img src='\images\posts\操作系统-信号量4.jpg'
  style="
    display: block;
    margin-left: auto;
    margin-right: auto; 
    zoom:50%;" />

根据前驱图可编写对应代码：

```c
semaphore mutex = 1; //互斥信号量，实现对缓冲区的互斥访问
semaphore empty = n; //同步信号量，表示空闲缓冲区的数量
semaphore full = 0;  //同步信号量,表示产品的数量,也即非空缓冲区的数量

Producer () {
    while(1) {
        生产一个产品;
        P(empty);   // 消耗一个空闲缓冲区
        P(mutex);   // 实现互斥是在同进程中进行一对PV操作
        把产品放入缓冲区; 
        V(mutex);   // 实现互斥是在同进程中进行一对PV操作
        V(full);    // 增加一个产品
    }
}

Consumer() {
    while(1) {
        P(full);    // 消耗一个产品（非空缓冲区）
        P(mutex);
        从缓冲区取出一个产品;
        V(mutex);
        V(empty);   // 增加一个空闲缓冲区
        使用产品;
    }
}
```

- mutex：实现互斥是在同进程中进行一对PV操作
- empty/full：实现两进程的同步关系，是在其中一个进程中执行P，另一进程中执行V

## 同步和互斥的顺序

假设将上述代码的P操作顺序进行互换，如下所示：

Producer：
```c 
P(mutex);   // 1.
P(empty);   // 2.
把产品放入缓冲区; 
V(mutex);
V(full);   
```

Consumer：
```c 
P(full);    // 3.
P(mutex);   // 4.
从缓冲区取出一个产品;
V(mutex);
V(empty);
```

若此时缓冲区内已经放满产品，则empty=0，full=n。
则生产者进程执行1使mutex变为0，再执行2，由于已**没有空闲缓冲区，因此生产者被阻塞**。
由于生产者阻塞，因此切换回消费者进程。
消费者进程执行3，**由于mutex为0**，即生产者还没释放对临界资源的“锁”，因此**消费者也被阻塞**。

这就造成了**生产者等待消费者释放空闲缓冲区**，而**消费者又等待生产者释放临界区**的情况。
生产者和消费者循环等待被对方唤醒，**出现“死锁”**。

同样的，若缓冲区中没有产品，即full=O，empty=n。按341的顺序执行就会发生死锁。

因此，实现**互斥的P操作一定要在实现同步的P操作之后**。

V操作不会导致进程阻塞，因此两个**V操作顺序可以交换**。
