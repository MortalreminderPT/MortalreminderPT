---
layout: post 
title: 操作系统（五）中断和异常 
description: 操作系统（Operating System，OS）是指控制和管理计算机系统软硬件资源，合理组织调度计算机工作和资源分配，提供给用户和其它软件方便的接口和环境。
date: 2022-04-20 18:09:49 +0800 
image: /images/covers/操作系统-cover1.png
tags:
- 操作系统
---

1. 目录
{:toc}

## 中断的作用
CPU上会运行两种程序，一种是**操作系统内核程序**，一种是**应用程序**。

在合适的情况下，操作系统内核会把CPU的使用权主动让给应用程序。

“中断”是**让操作系统内核夺回CPU使用权的唯一途径**。

如果没有“中断”机制，那么一旦应用程序上CPU运行，CPU就会一直运行这个应用程序（没有中断，就没有并发）。

## 中断的类型

广义上中断包括内中断（又称异常）和外中断（狭义上的中断）两种。

内中断与当前执行的**指令有关**，中断信号来源于**CPU内部**。

外中断与当前执行的**指令无关**，中断信号来源于**CPU外部**。

### 内中断（异常）类型：
1. 陷入（trap）：由陷入指令引发，是应用程序故意引发的；
2. 故障（fault）：由错误条件引起的，可能被内核程序修复。内核程序修复故障后会把CPU使用权还给应用程序，让它继续执行下去。如缺页故障等；
3. 终止（abort）：由致命错误引起，内核程序无法修复该错误，因此一般不再将CPU使用权还给引发终止的应用程序，而是直接终止该应用程序。如整数除0、非法使用特权指令等。

### 外中断类型：
包括时钟中断、I/O中断等。


### 内中断（异常）示例

**终止指令**：若当前执行的指令是非法的，则会引发一个中断信号。

    1. 试图在用户态下执行特权指令
    2. 执行除法指令时发现除数为0

**陷入指令**：有时候应用程序想请求操作系统内核的服务，此时会执行一条特殊的指令――陷入指令，该指令会引发一个内部中断信号。

执行“陷入指令”，意味着应用程序主动地将CPU控制权还给操作系统内核。“系统调用”就是通过陷入指令完成的。

### 外中断示例

**每一条指令执行结束时**，CPU都会例行检查是否有外中断信号。

时钟中断：时钟部件每隔一个时间片（如50ms）会给CPU发送一个时钟中断信号。时钟中断的过程如下：

1. 在应用程序1的执行过程中，执行时间达到一个时间片，CPU分给该应用程序的时间耗尽。
2. 此时时钟部件向CPU发送一个时钟中断信号，CPU转变为内核态并执行处理时钟中断的内核程序。操作系统内核决定接下来让应用程序2在上CPU运行。
3. 接下来切换为用户态执行应用程序2，如此往复。

I/O中断：由输入/输出设备发来的中断信号。当输入/输出任务完成后，向CPU发送中断信号。

## 中断机制的基本原理

不同的中断信号，需要用不同的中断处理程序来处理。当CPU检测到中断信号后，会根据中断信号的类型去查询“**中断向量表**”，以此来找到相应的中断处理程序在内存中的存放位置。

<img src='\images\posts\操作系统-中断向量表示例.jpg'
  style="
    display: block;
    margin-left: auto;
    margin-right: auto; 
    zoom:50%;" />

**中断处理程序一定是内核程序**，因此需要运行在“内核态”。
