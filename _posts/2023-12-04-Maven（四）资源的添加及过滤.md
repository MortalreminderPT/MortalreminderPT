---
layout: post 
title: Maven（四）资源的添加及过滤
description:
date: 2023-12-04 09:25:23 +0800 
image: /images/covers/maven-cover.jpg
tags:
- Maven
category: ['Maven']
---

1. 目录
{:toc}

## 将资源添加到 JAR 中

Maven 中，无需更改上面的 POM 即可满足的**另一个常见用例**是将**资源打包在 JAR 文件中**。对于此常见任务，Maven 再次依赖于[Standard Directory Layout](https://maven.apache.org/guides/introduction/introduction-to-the-standard-directory-layout.html)，这意味着通过使用标准 Maven 约定，您只需将这些**资源放置在标准目录结构中即可将资源打包到 JAR 中**。

您可以在下面的示例中看到，我们添加了一个目录`${project.basedir}/src/main/resources`，我们可以在该目录中放置我们希望打包到 JAR 中的任何资源。Maven 采用的简单规则是这样的：放置在`${project.basedir}/src/main/resources`目录中的任何目录或文件都将打包在 JAR 中，并且从 JAR 的底部开始具有完全相同的结构。

```bash
my-app
|-- pom.xml
`-- src
    |-- main
    |   |-- java
    |   |   `-- com
    |   |       `-- mycompany
    |   |           `-- app
    |   |               `-- App.java
    |   `-- resources
    |       `-- META-INF
    |           `-- application.properties
    `-- test
        `-- java
            `-- com
                `-- mycompany
                    `-- app
                        `-- AppTest.java
```

因此，您可以在我们的示例中看到，我们有一个`META-INF`目录，该目录中包含一个`application.properties`文件。如果您解压 Maven 为您创建的 JAR 并查看它，您将看到以下内容：

```bash
|-- META-INF
|   |-- MANIFEST.MF
|   `-- application.properties
|   `-- maven
|       `-- com.mycompany.app
|           `-- my-app
|               |-- pom.properties
|               `-- pom.xml
`-- com
    `-- mycompany
        `-- app
            `-- App.class
```

正如你所看到的，`${project.basedir}/src/main/resources` 的内容可以从 JAR 的底部开始找到，而我们的 `application.properties` 文件则位于 `META-INF` 目录中。你还会注意到其他一些文件，如 `META-INF/MANIFEST.MF`，以及 `pom.xml` 和 `pom.properties` 文件。这些都是在 Maven 中生成 JAR 时的标准配置。您可以选择创建自己的清单，但如果不创建，Maven 会默认生成一个清单。（您也可以修改默认清单中的条目。我们稍后将讨论这个问题）。`pom.xml` 和 `pom.properties` 文件打包在 JAR 中，因此 Maven 生成的每个构件都是自描述的，如果需要，您还可以在自己的应用程序中使用元数据。一个简单的用途可能是检索应用程序的版本。对 POM 文件进行操作需要使用一些 Maven 工具，但可以使用标准 Java API 来使用属性，如下所示：

```properties
#Generated by Maven
#Tue Oct 04 15:43:21 GMT-05:00 2005
version=1.0-SNAPSHOT
groupId=com.mycompany.app
artifactId=my-app
```

要将资源添加到单元测试的类路径中，请遵循与将资源添加到 JAR 中相同的模式，只不过放置资源的目录是`${project.basedir}/src/test/resources`。此时，您将拥有一个如下所示的项目目录结构：

```bash
my-app
|-- pom.xml
`-- src
    |-- main
    |   |-- java
    |   |   `-- com
    |   |       `-- mycompany
    |   |           `-- app
    |   |               `-- App.java
    |   `-- resources
    |       `-- META-INF
    |           |-- application.properties
    `-- test
        |-- java
        |   `-- com
        |       `-- mycompany
        |           `-- app
        |               `-- AppTest.java
        `-- resources
            `-- test.properties
```

在单元测试中，您可以使用如下所示的简单代码片段来访问测试所需的资源：

```java
// ...
// 检索资源
InputStream is = getClass().getResourceAsStream( "/test.properties" );
// 对资源做一些事情
// ...
```

## 过滤资源文件

有时，资源文件需要包含一个**只能在构建时提供的值**。

要在 Maven 中实现这一点，可使用 `${<property name>}` 语法在资源文件中引用包含该值的属性。该属性可以是 pom.xml 、 settings.xml 、外部属性文件或系统属性中定义的值。

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
 
  <groupId>com.mycompany.app</groupId>
  <artifactId>my-app</artifactId>
  <version>1.0-SNAPSHOT</version>
  <packaging>jar</packaging>
 
  <name>Maven Quick Start Archetype</name>
  <url>http://maven.apache.org</url>
 
  <dependencies>
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>4.11</version>
      <scope>test</scope>
    </dependency>
  </dependencies>
 
  <build>
    <resources>
      <resource>
        <directory>src/main/resources</directory>
        <filtering>true</filtering>
      </resource>
    </resources>
  </build>
</project>
```

我们必须添加以前不存在的`build`、`resources`和`resource`元素。此外，我们必须明确声明资源位于 `src/main/resources` 目录中。所有这些信息之前都是作为默认值提供的，但由于默认值`filtering`是 false，我们必须将其添加到 pom.xml 中才能覆盖该默认值并设置`filtering`为 true。

要引用 pom.xml 中定义的属性，属性名称会使用定义值的 XML 元素名称，其中 **`pom` 可以作为项目（根）元素的别名**。因此，`${project.name}` 指的是项目的名称，`${project.version}` 指的是项目的版本，`${project.build.finalName}` 指的是构建项目打包时创建的文件的最终名称，等等。请注意，POM 中的某些元素具有默认值，因此无需在 `pom.xml` 中明确定义即可在此处使用。**同样，用户 `settings.xml` 中的值可以使用以 `settings` 开头的属性名来引用**（例如，`${settings.localRepository}` 指的是用户本地存储库的路径）。

继续我们的示例，让我们在 `application.properties` 文件（放在 `src/main/resources` 目录中）中添加几个属性，这些属性的值将在过滤资源时提供：

```properties
# application.properties
application.name=${project.name}
application.version=${project.version}
```

有了这些，就可以执行以下命令（process-resources 是构建生命周期阶段，在此阶段会复制和过滤资源）：

```bash
mvn process-resources
```

而 `target/classes` 下的 `application.properties` 文件（最终将被放入 jar 中）看起来像这样：

```properties
# application.properties
application.name=Maven Quick Start Archetype
application.version=1.0-SNAPSHOT
```

要**引用外部文件中定义的属性**，只需在 pom.xml 中添加对该外部文件的引用即可。首先，让我们创建外部属性文件，并将其命名为`src/main/filters/filter.properties`：

```properties
# filter.properties
my.filter.value=hello!
```

接下来，我们将在 `pom.xml` 中添加对这个新文件的引用：

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
 
  <groupId>com.mycompany.app</groupId>
  <artifactId>my-app</artifactId>
  <version>1.0-SNAPSHOT</version>
  <packaging>jar</packaging>
 
  <name>Maven Quick Start Archetype</name>
  <url>http://maven.apache.org</url>
 
  <dependencies>
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>4.11</version>
      <scope>test</scope>
    </dependency>
  </dependencies>
 
  <build>
    <filters>
      <filter>src/main/filters/filter.properties</filter>
    </filters>
    <resources>
      <resource>
        <directory>src/main/resources</directory>
        <filtering>true</filtering>
      </resource>
    </resources>
  </build>
</project>
```

随后，我们可以在 `application.properties` 文件中添加对该属性的引用：

```properties
# application.properties
application.name=${project.name}
application.version=${project.version}
message=${my.filter.value}
```

下一次执行 `mvn process-resources` 命令时，就会将新的属性值放入 `application.properties` 中。如果不在外部文件中定义 `my.filter.value` 属性，也可以在 `pom.xml` 的 properties 部分中定义，这样也能达到同样的效果（不需要引用`src/main/filters/filter.properties`）：

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
 
  <groupId>com.mycompany.app</groupId>
  <artifactId>my-app</artifactId>
  <version>1.0-SNAPSHOT</version>
  <packaging>jar</packaging>
 
  <name>Maven Quick Start Archetype</name>
  <url>http://maven.apache.org</url>
 
  <dependencies>
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>4.11</version>
      <scope>test</scope>
    </dependency>
  </dependencies>
 
  <build>
    <resources>
      <resource>
        <directory>src/main/resources</directory>
        <filtering>true</filtering>
      </resource>
    </resources>
  </build>
 
  <properties>
    <my.filter.value>hello</my.filter.value>
  </properties>
</project>
```

过滤资源还可以从系统属性中获取值；这些属性可以是 Java 内置的系统属性（如 `java.version` 或 `user.home`），也可以是使用标准 Java -D 参数在命令行中定义的属性。继续举例说明，让我们把 `application.properties` 文件改成下面的样子：

```properties
# application.properties
java.version=${java.version}
command.line.prop=${command.line.prop}
```

现在，当你执行以下命令时（注意命令行中 command.line.prop 属性的定义），`application.properties` 文件将包含系统属性中的值。

```bash
mvn process-resources "-Dcommand.line.prop=hello again"
```
