---
layout: post 
title: 操作系统（九）虚拟机 
description: 操作系统（Operating System，OS）是指控制和管理计算机系统软硬件资源，合理组织调度计算机工作和资源分配，提供给用户和其它软件方便的接口和环境。
date: 2022-04-20 22:39:30 +0800 
image: /images/covers/操作系统-cover1.png
tags:
- 操作系统
---

1. 目录
{:toc}

## 虚拟机的定义

在同一台操作系统上并发运行某些进程，可能存在安全隐患；如果将其运行在不同硬件上，则会浪费大量硬件资源。

虚拟机：使用虚拟化技术，将一台物理机器虚拟化为多台虚拟机器（Virtual Machine，VM），每个虚拟机器都可以独立运行一个操作系统。

同义术语：虚拟机管理程序/虚拟机监控程序/Virtual Machine Monitor/Hypervisor

## 第一类虚拟机
第一类虚拟机管理程序直接运行在硬件上。虚拟机管理程序将一个物理机器虚拟化为多台虚拟机器。
第一类虚拟机管理程序会把一个总的硬件资源划分为多个部分，每一台虚拟机上可以安装各自的操作系统，如下图所示：

<img src='\images\posts\操作系统-第一类虚拟机.jpg'
  style="
    display: block;
    margin-left: auto;
    margin-right: auto; 
    zoom:50%;" />

在运行过程中，CPU的时间片被分给若干个虚拟机器，在上层操作系统看来自己分配的是独立的CPU；而磁盘和内存这些则是按空间进行划分。每台机器都拥有自己独立的资源。

在第一类虚拟机中，**只有虚拟机管理程序是运行在内核态**的，可以使用那些最高特权的指令。
上层**虚拟内核空间运行在用户态**，但它以为自己运行在内核态，会执行特权指令，此时这个**特权指令会被虚拟机管理程序截获并进行等价转换**。

## 第二类虚拟机
第二类虚拟机管理程序运行在宿主操作系统（Host OS）上。

常用第二类虚拟机：VirtualBox、VMWare

第二类虚拟机想要为虚拟机器分配硬件资源时，需要请求操作系统为其分配。**硬件资源的管理者依旧是宿主操作系统**。

注意：在第二类虚拟机中，**部分虚拟机管理程序运行在内核态**，这部分是**以虚拟机驱动程序的方式加载到操作系统内核**当中的。

<img src='\images\posts\操作系统-第二类虚拟机.jpg'
  style="
    display: block;
    margin-left: auto;
    margin-right: auto; 
    zoom:50%;" />

## 两类虚拟机的对比

| |第一类VMM|第二类VMM|
|----|----|---|
|对物理资源的控制权|直接运行在硬件之上，能直接控制和分配物理资源。|运行在Host OS之上，依赖于Host OS为其分配物理资源。|
|资源分配方式|在安装Guest OS时，VMM要在原本的硬盘上自行分配存储空间，类似于”外核“的分配方式，分配未经抽象的物理硬件。|Guest OS拥有自己的虚拟磁盘，该盘实际上是Host OS文件系统中的一个大文件。Guest OS分配到的内存是虚拟内存。|
|性能|性能较好。|性能更差，需要Host OS作为”中介“。|
|可支持的虚拟机数量|更多，不需要和Host OS竞争资源，相同的硬件资源可以支持更多的虚拟机。|更少，Host OS本身需要使用物理资源，Host OS上运行的其他进程也需要物理资源。|
|虚拟机的可迁移性|更差。|更好，只需导出虚拟机镜像文件即可迁移到另一台Host OS 上，商业化应用更广泛。|
|运行模式|第一类VMM运行在最高特权级（Ring 0），可以执行最高特权的指令。|第二类VMM部分运行在用户态、部分运行在内核态。Guest OS发出的系统调用会被VMM截获，并转化为VMM对Host OS的系统调用。|

## 更多指令等级
支持虚拟化的CPU通常分为更多的指令等级，如下图所示：

<img src='\images\posts\操作系统-虚拟化CPU指令等级.jpg'
  style="
    display: block;
    margin-left: auto;
    margin-right: auto; 
    zoom:50%;" />

其中，Ring 0表示最高特权级指令；Ring 3表示最低特权级指令。

在第一类虚拟机中，可以使VMM运行在Ring 0，虚拟内核空间运行在Ring 1，虚拟用户空间运行在Ring 2。这样可以保证在运行特权指令Ring 1和Ring 2时，虚拟机管理程序无需介入，提升运行效率。
